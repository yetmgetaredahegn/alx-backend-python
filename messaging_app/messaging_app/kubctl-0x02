#!/bin/bash
set -e

echo "=== Starting Task 4: Blue-Green Deployment ==="

echo "1. Applying blue deployment..."
kubectl apply -f blue_deployment.yaml

echo "2. Applying green deployment..."
kubectl apply -f green_deployment.yaml

echo "3. Waiting for green pods to be ready..."
kubectl rollout status deployment/messaging-app-green --timeout=90s || echo "Green deployment not ready"

echo "4. Checking logs of green version..."
GREEN_POD=$(kubectl get pods -l app=messaging-app,version=green -o jsonpath='{.items[0].metadata.name}')
kubectl logs "$GREEN_POD" --tail=10 || echo "Unable to fetch logs"

echo "5. Switching service to green version..."
kubectl patch service messaging-app \
  -p '{"spec": {"selector": {"app": "messaging-app", "version": "green"}}}'

echo "6. Current service selector:"
kubectl get service messaging-app -o yaml | grep "selector" -A 2

echo "===  Blue-Green Deployment: Green is now live ==="
